<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cash Flow Tool</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial; padding: 20px; max-width: 900px; margin: auto; }
  input, select, button { margin: 5px; padding: 5px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  .chart-box { text-align: center; }
  canvas { max-width: 100%; height: auto; }
  .charts-container { display: flex; gap: 40px; align-items: flex-start; margin-top: 30px; flex-wrap: wrap; }
  .summary-container { display: flex; align-items: flex-start; gap: 40px; margin-top: 20px; }
  @media (max-width: 900px) { .charts-container { flex-direction: column; } .summary-container { flex-direction: column; } }
</style>
</head>
<body>

<h2>Cash Flow Analysis</h2>

<form id="cashForm">
  <input type="date" id="date" required>
  <input type="text" id="desc" placeholder="Description / Category" required>
  <input type="number" id="amount" placeholder="Amount" required>
  <select id="type">
    <option value="income">Income</option>
    <option value="expense">Expense</option>
  </select>
  <button type="submit">Add</button>
</form>

<div class="summary-container">
  <div class="summary">
    <p>Total Income: $<span id="totalIncome">0</span></p>
    <p>Total Expenses: $<span id="totalExpenses">0</span></p>
    <p>Net Cash Flow: $<span id="netFlow">0</span></p>
  </div>

  <div class="charts-container">
    <!-- Net Cash Flow Line Chart -->
    <div class="chart-box" style="flex:1; min-width:300px;">
      <h3>Historical Net Cash Flow</h3>
      <canvas id="netFlowChart"></canvas>
    </div>

    <!-- Pie Chart on the Right -->
    <div class="chart-box" style="flex:1; min-width:300px;">
      <h3>Cash Flow by Category</h3>
      <canvas id="cashFlowPie"></canvas>
    </div>
  </div>
</div>

<div style="margin-top:20px;">
  <label>View from: <input type="date" id="startDate"></label>
  <label>to: <input type="date" id="endDate"></label>
  <button id="applyFilterBtn">Apply Filter</button>
</div>

<table>
  <thead>
    <tr><th>Date</th><th>Description</th><th>Amount</th><th>Type</th></tr>
  </thead>
  <tbody id="entryTable"></tbody>
</table>

<script>
const form = document.getElementById('cashForm');
let entries = [];
let descriptionMap = {};

const dateInput = document.getElementById('date');
const descInput = document.getElementById('desc');
const amountInput = document.getElementById('amount');
const typeSelect = document.getElementById('type');

// Default date today
dateInput.value = new Date().toISOString().split('T')[0];

// Charts
const cashFlowCtx = document.getElementById('cashFlowPie').getContext('2d');
const netFlowCtx = document.getElementById('netFlowChart').getContext('2d');

const cashFlowChart = new Chart(cashFlowCtx, {
  type: 'pie',
  data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
  options: { responsive: true }
});

const netFlowChart = new Chart(netFlowCtx, {
  type: 'line',
  data: { labels: [], datasets: [{ label: 'Net Cash Flow', data: [], borderColor: 'blue', backgroundColor: 'rgba(0,0,255,0.1)', fill: true, tension: 0.2 }] },
  options: { responsive: true }
});

// Color generators
function getGreenShade() { return `hsl(${Math.floor(Math.random()*30)+100}, ${Math.floor(Math.random()*30)+60}%, ${Math.floor(Math.random()*30)+40}%)`; }
function getRedShade() { return `hsl(${Math.floor(Math.random()*20)+0}, ${Math.floor(Math.random()*30)+60}%, ${Math.floor(Math.random()*30)+40}%)`; }

// Autofill description
descInput.addEventListener('input', () => {
  const desc = descInput.value.trim();
  if (descriptionMap[desc]) {
    amountInput.value = descriptionMap[desc].amount;
    typeSelect.value = descriptionMap[desc].type;
  }
});

// Filter elements
const startDate = document.getElementById('startDate');
const endDate = document.getElementById('endDate');
const applyFilterBtn = document.getElementById('applyFilterBtn');

function getFilteredEntries() {
  const start = startDate.value ? new Date(startDate.value) : null;
  const end = endDate.value ? new Date(endDate.value) : null;
  return entries.filter(e => {
    const d = new Date(e.date);
    if(start && d<start) return false;
    if(end && d>end) return false;
    return true;
  });
}

function updateTable(filteredEntries) {
  const tbody = document.getElementById('entryTable');
  tbody.innerHTML = '';
  filteredEntries.forEach(e => {
    tbody.innerHTML += `<tr>
      <td>${e.date}</td>
      <td>${e.description}</td>
      <td>${e.amount.toFixed(2)}</td>
      <td>${e.type}</td>
    </tr>`;
  });
}

function updateSummary(filteredEntries) {
  let income=0, expense=0;
  filteredEntries.forEach(e => e.type==='income'? income+=e.amount : expense+=e.amount);
  document.getElementById('totalIncome').innerText = income.toFixed(2);
  document.getElementById('totalExpenses').innerText = expense.toFixed(2);
  document.getElementById('netFlow').innerText = (income-expense).toFixed(2);
}

function updateCashFlowChart(filteredEntries) {
  const dataMap = {};
  const colorMap = {};
  filteredEntries.forEach(e=>{
    dataMap[e.description] = (dataMap[e.description]||0)+e.amount;
    colorMap[e.description] = e.type==='income'?getGreenShade():getRedShade();
  });
  const labels=Object.keys(dataMap);
  const data=Object.values(dataMap);
  const colors=labels.map(l=>colorMap[l]);
  cashFlowChart.data.labels=labels;
  cashFlowChart.data.datasets[0].data=data;
  cashFlowChart.data.datasets[0].backgroundColor=colors;
  cashFlowChart.update();
}

function updateNetFlowChart(filteredEntries) {
  const sorted=[...filteredEntries].sort((a,b)=>new Date(a.date)-new Date(b.date));
  const labels=[], data=[];
  let cumulative=0;
  sorted.forEach(e=>{
    cumulative += e.type==='income'? e.amount : -e.amount;
    labels.push(e.date);
    data.push(cumulative);
  });
  netFlowChart.data.labels=labels;
  netFlowChart.data.datasets[0].data=data;
  netFlowChart.update();
}

// DB integration
const USER="demoUser";

window.addEventListener("DOMContentLoaded", async ()=>{
  try{
    const res = await fetch(`/api/entries/${USER}`);
    const savedEntries = await res.json();
    entries.push(...savedEntries);
    applyFilter();
  }catch(err){ console.error(err); }
});

async function saveToDatabase(entry){
  try{
    await fetch("/api/entries",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ user:USER, ...entry })
    });
  }catch(err){ console.error(err); }
}

function applyFilter() {
  const filtered = getFilteredEntries();
  updateTable(filtered);
  updateSummary(filtered);
  updateCashFlowChart(filtered);
  updateNetFlowChart(filtered);
}

applyFilterBtn.addEventListener('click', applyFilter);

form.addEventListener('submit', async function(e){
  e.preventDefault();
  const date=dateInput.value;
  const description=descInput.value.trim();
  const amount=parseFloat(amountInput.value);
  const type=typeSelect.value;
  if(!description || isNaN(amount) || !date || !type){ alert("Please fill all fields correctly"); return; }

  const entry={date, description, amount, type};
  entries.push(entry);
  descriptionMap[description]={amount,type};

  await saveToDatabase(entry);
  form.reset();
  dateInput.value=new Date().toISOString().split('T')[0];
  applyFilter();
});
</script>
</body>
</html>
